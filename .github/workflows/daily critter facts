name: Daily Critter Facts

on:
  schedule:
    - cron: "10 12 * * *" # daily 12:10 UTC (adjust later)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_MODEL: "gpt-4o-mini"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Update daily facts in JSON
        run: |
          python - <<'PY'
          import os, json, datetime, time, requests

          API_KEY = os.environ.get("OPENAI_API_KEY")
          MODEL = os.environ.get("OPENAI_MODEL", "gpt-4o-mini")
          if not API_KEY:
              raise SystemExit("Missing OPENAI_API_KEY secret")

          PATH = "data/critter-data.json"
          with open(PATH, "r", encoding="utf-8") as f:
              data = json.load(f)

          if not isinstance(data, dict) or "critters" not in data or not isinstance(data["critters"], list):
              raise SystemExit("JSON must be { critters: [...] }")

          critters = data["critters"]
          if not critters:
              raise SystemExit("critters array is empty")

          # Daily stamps
          now = datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z"
          today = datetime.datetime.utcnow().date().isoformat()
          data["lastUpdated"] = now
          data["runId"] = today

          def call_openai(name: str, summary: str, prev_fact: str) -> str:
              url = "https://api.openai.com/v1/chat/completions"
              headers = {"Authorization": f"Bearer {API_KEY}", "Content-Type": "application/json"}
              payload = {
                  "model": MODEL,
                  "temperature": 1.0,
                  "max_tokens": 220,
                  "messages": [
                      {"role": "system", "content": "Write accurate wildlife facts. No profanity. No speculation. Plain text."},
                      {"role": "user", "content":
                          f"Write ONE educational fact about {name} for a wildlife Twitch stream.\n"
                          f"Context summary: {summary}\n"
                          f"Rules:\n"
                          f"- 1 to 2 sentences\n"
                          f"- Target 140–220 characters (longer than before)\n"
                          f"- Must be different from yesterday’s fact: {prev_fact!r}\n"
                          f"- No ages/birthdays. No fake sightings. No sensational claims.\n"
                      }
                  ]
              }
              r = requests.post(url, headers=headers, json=payload, timeout=90)
              if r.status_code >= 400:
                  raise SystemExit(f"OpenAI error {r.status_code}: {r.text[:400]}")
              out = r.json()
              txt = (out["choices"][0]["message"]["content"] or "").strip().replace("\n"," ")
              return txt

          changed = 0
          for c in critters:
              name = (c.get("name") or "").strip()
              summary = (c.get("summary") or "").strip()
              old = (c.get("fact") or "").strip()

              if not name:
                  continue

              new = call_openai(name, summary, old)
              if new and new != old:
                  c["fact"] = new
                  changed += 1

              time.sleep(0.35)

          if changed == 0:
              raise SystemExit("No facts changed. Failing run so you notice immediately.")

          with open(PATH, "w", encoding="utf-8") as f:
              json.dump(data, f, indent=2, ensure_ascii=False)

          print("Updated:", now, "runId:", today, "facts changed:", changed)
          PY

      - name: Commit and push
        run: |
          set -e
          git config user.name "crittercamp-bot"
          git config user.email "actions@users.noreply.github.com"

          git add data/critter-data.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Daily critter facts refresh"
          git push origin HEAD:main
