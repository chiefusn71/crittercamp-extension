name: Hourly Critter Facts

on:
  schedule:
    - cron: "0 * * * *" # hourly (UTC)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      UPDATE_COUNT: "71" # change to 10-15 recommended

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Hard-sync workspace to origin/main
        run: |
          set -e
          git fetch origin main
          git reset --hard origin/main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Generate fresh facts and update JSON (FAIL if facts don't change)
        run: |
          python - <<'PY'
          import os, json, datetime, time, requests

          API_KEY = os.environ.get("OPENAI_API_KEY")
          if not API_KEY:
              raise SystemExit("Missing OPENAI_API_KEY secret")

          PATH = "data/critter-data.json"

          with open(PATH, "r", encoding="utf-8") as f:
              data = json.load(f)

          # Support either:
          # 1) [ {critter}, ... ]
          # 2) { lastUpdated, critters:[...] }
          if isinstance(data, list):
              data = {"lastUpdated": None, "cursor": 0, "critters": data}

          critters = data.get("critters")
          if not isinstance(critters, list) or not critters:
              raise SystemExit("critter-data.json must be an array OR { critters: [...] }")

          # rotation cursor
          cursor = data.get("cursor", 0)
          if not isinstance(cursor, int):
              cursor = 0

          UPDATE_COUNT = int(os.environ.get("UPDATE_COUNT", "12"))
          UPDATE_COUNT = max(1, min(UPDATE_COUNT, len(critters)))

          # choose next UPDATE_COUNT critters in a loop
          picks = []
          for i in range(UPDATE_COUNT):
              picks.append((cursor + i) % len(critters))
          data["cursor"] = (cursor + UPDATE_COUNT) % len(critters)

          now = datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z"
          data["lastUpdated"] = now
          data["runId"] = now  # proof stamp

          def chat_completion(animal_name: str, avoid: list[str]) -> str:
              url = "https://api.openai.com/v1/chat/completions"
              headers = {
                  "Authorization": f"Bearer {API_KEY}",
                  "Content-Type": "application/json",
              }

              avoid_text = "\n".join([f"- {a}" for a in avoid if a]) or "- (none)"

              payload = {
                  "model": "gpt-4o-mini",
                  "temperature": 1.2,
                  "messages": [
                      {
                          "role": "system",
                          "content": "You write accurate, short wildlife facts. No profanity. No speculation. Plain text."
                      },
                      {
                          "role": "user",
                          "content": (
                              f"Write ONE accurate fun fact about {animal_name}.\n"
                              "Rules:\n"
                              "- Max 18 words\n"
                              "- Must be clearly different from ALL of these recent facts:\n"
                              f"{avoid_text}\n"
                              "- No ages/birthdays, no medical claims, no speculation\n"
                          )
                      }
                  ]
              }

              r = requests.post(url, headers=headers, json=payload, timeout=90)
              if r.status_code >= 400:
                  raise RuntimeError(f"OpenAI error {r.status_code}: {r.text[:300]}")
              out = r.json()
              text = (out["choices"][0]["message"]["content"] or "").strip().replace("\n", " ")
              return text

          successes = 0
          failures = 0
          unchanged = 0
          errors = []

          for idx in picks:
              c = critters[idx]
              name = (c.get("name") or "").strip()
              if not name:
                  continue

              old_fact = (c.get("fact") or "").strip()

              # keep small history so we can avoid repeats
              hist = c.get("factHistory")
              if not isinstance(hist, list):
                  hist = []
              hist = [h for h in hist if isinstance(h, str) and h.strip()]
              hist = hist[-5:]  # last 5 only

              avoid = [old_fact] + hist

              try:
                  new_fact = chat_completion(name, avoid)

                  if not new_fact:
                      raise RuntimeError("Empty fact returned")

                  # if model still repeats, count it and force failure visibility
                  if new_fact == old_fact or new_fact in hist:
                      unchanged += 1
                  else:
                      # push old into history then set new
                      if old_fact:
                          hist.append(old_fact)
                      c["factHistory"] = hist[-5:]
                      c["fact"] = new_fact
                      successes += 1

              except Exception as e:
                  failures += 1
                  errors.append(f"{name}: {e}")

              time.sleep(0.4)

          # HARD RULE: if nothing actually changed, fail the run
          if successes == 0:
              msg = (
                  f"NO FACTS CHANGED. successes={successes} failures={failures} unchanged={unchanged}\n"
                  + ("\n".join(errors[:8]) if errors else "")
              )
              raise SystemExit(msg)

          with open(PATH, "w", encoding="utf-8") as f:
              json.dump(data, f, indent=2, ensure_ascii=False)

          print("Updated timestamp:", now)
          print(f"Updated facts: {successes}/{UPDATE_COUNT} | failures={failures} | unchanged={unchanged}")
          if errors:
              print("Sample errors:")
              for e in errors[:8]:
                  print(" -", e)
          PY

      - name: Commit and push (only if changed)
        run: |
          set -e
          git config user.name "crittercamp-bot"
          git config user.email "actions@users.noreply.github.com"

          git add data/critter-data.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Hourly critter fact refresh"
          git push origin main
